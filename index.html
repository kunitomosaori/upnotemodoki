<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ぽちポケ</title>
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">
</head>


<body>
  <h1 id="status"> Login... </h1>

  <!-- コンテンツ表示画面 -->
  <header>
    <div class="header-wrapping">
      <h1 class="header-font">ぽちポケ</h1>
      <input type="text" id="search-box" placeholder="search">
      <div class="header-text">
        <img src="" id="prof">
        user name <span id="uname"></span>
        <button id="out">logout</button>
      </div>
    </div>
  </header>

  <main>

    <div class="container">
      <!-- サイドメニュー -->
      <div class="side-menu">
        <button id="list_display_switch">三</button>
        <div class="notebooks">
          <button id="list_display">▽</button>
          <span>NOTEBOOKS</span>
          <button id="new-key">＋</button>
          <div id="list" class="hidden list">
            <!-- ここに追加データが挿入される -->
          </div>
        </div>
        <div class="side-menu-button">

        </div>
      </div>


      <!-- メインメニュー -->
      <div class="main-contents">
        <input type="text" id="key" placeholder="タイトル">
        <textarea id="memo" placeholder="メモを入力"></textarea>
        <div>
          <input type="text" id="tags" placeholder="タグを追加 (カンマ区切りで入力)">
        </div>
        <div class="main-fotter-button">
          <button id="save">save</button>
        </div>
      </div>
    </div>


  </main>

  <!-- jQueryの読み込み -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- 独自のJavaScriptファイルの読み込み -->
  <script src="js/main.js"></script>
  <!-- 以下firebase -->
  <script type="module">
    //###############################################
    // 必要なJSを読み込み
    //###############################################
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/9.13.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, onChildAdded, remove, onChildRemoved }
      from "https://www.gstatic.com/firebasejs/9.13.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/9.13.0/firebase-auth.js";


    //###############################################
    //FirebaseConfig [ KEYを取得して設定！！ ]
    //###############################################
    const firebaseConfig = {
      apiKey: "AIzaSyDVq2QiPiot5hzhUMdrlj1ibJZPctDcTV4",
      authDomain: "pochi-6400b.firebaseapp.com",
      projectId: "pochi-6400b",
      storageBucket: "pochi-6400b.appspot.com",
      messagingSenderId: "882528790400",
      appId: "1:882528790400:web:77c694ec929d3ca6698365"
    };
    const app = initializeApp(firebaseConfig);

    //###############################################
    //Firebase-RealtimeDatabase接続
    //###############################################
    const db = getDatabase(app); //RealtimeDBに接続

    //###############################################
    //GoogleAuth用
    //###############################################
    const provider = new GoogleAuthProvider();
    provider.addScope('https://www.googleapis.com/auth/contacts.readonly');
    const auth = getAuth();

    //###############################################
    //Loginしていれば処理します
    //###############################################
    // リストのデータをクリックしたときにメインコンテンツに反映する
    function updateMainContents(title, text) {
      $("#key").val(title);
      $("#memo").val(text);
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid; //ユーザー情報取得できます
        if (user !== null) {
          user.providerData.forEach((profile) => {
            //Login情報取得
            $("#uname").text(profile.displayName);
            $("#prof").attr("src", profile.photoURL);
          });
          $("#status").fadeOut(500);
        }

        // メモリストを取得するためのリファレンス
        const usermemoRef = ref(db, `users/${uid}/memo/`);

        // 既存のリストをクリア
        $('#list').empty();

        // Adding data to the list
        onChildAdded(usermemoRef, (data) => {
          const memodata = data.val();
          const key = data.key;
          const tags = memodata.tags.join(', '); // タグをカンマ区切りで表示

          // メモデータのタイトルを表示する要素
          const item = $('<div>').addClass('clickable-item').html(`${memodata.title} <span class="tags">(${tags})</span>`);

          // データをクリックしたときのイベントハンドラを追加
          item.on('click', function () {
            updateMainContents(memodata.title, memodata.text);
            $('#tags').val(tags); // タグを入力欄に表示
          });

          // 削除ボタンを追加
          const deleteButton = $('<button>').text('Delete').addClass('delete-button');
          deleteButton.on('click', function () {
            remove(ref(db, `users/${uid}/memo/${key}`));
            item.remove(); // 表示も削除
          });

          // リストに項目を追加
          item.append(deleteButton);
          $('#list').append(item);
        });

        // 保存ボタンのクリックイベント
        $('#save').on('click', function () {
          const tags = $('#tags').val().split(',').map(tag => tag.trim()); // タグを配列として取得
          const msg = {
            title: $('#key').val(),
            text: $('#memo').val(),
            tags: tags // タグを保存
          }
          const dbRef = ref(db, `users/${auth.currentUser.uid}/memo/${msg.title}`);
          set(dbRef, msg);
        });

        updateList(); // 初期ロード時にリストを更新

        // 検索処理
        $('#search-box').on('input', function () {
          const searchQuery = $(this).val().toLowerCase();
          $('.clickable-item').each(function () {
            const itemText = $(this).text().toLowerCase();
            if (itemText.includes(searchQuery)) {
              $(this).show(); // 検索に一致する場合は表示
            } else {
              $(this).hide(); // 一致しない場合は非表示
            }
          });
        });

        // 既存のメモデータを読み込むためのイベントリスナー
        $('#key').on('change', function () {
          const key = $(this).val();
          const dbRef = ref(db, `users/${uid}/memo/${key}`);
          onValue(dbRef, (data) => {
            const msg = data.val();
            if (msg) {
              $('#memo').val(msg.text);
            }
          });
        });
      } else {
        _redirect(); // User is signed out
      }
    });

    //###############################################
    //Logout処理
    //###############################################
    $("#out").on("click", function () {
      // signInWithRedirect(auth, provider);
      signOut(auth).then(() => {
        // Sign-out successful.
        _redirect();
      }).catch((error) => {
        // An error happened.
        console.error(error);
      });
    });


    //###############################################
    //Login画面へリダイレクト(関数作成)
    //###############################################
    function _redirect() {
      location.href = "login.html";
    }

  </script>
</body>

</body>

</html>